<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ‹å­¸å°å­¸å ‚ï¼šéŠæˆ²æ‰“åŒ…å·¥å…· (ä¿®å¾©ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f3f4f6; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-2xl w-full border-4 border-blue-500 text-center">
        <div class="mb-6 text-6xl">ğŸ› ï¸</div>
        <h1 class="text-3xl font-bold text-gray-800 mb-2">å°è¯éŠæˆ²æ‰“åŒ…å·¥å…· (ä¿®å¾©ç‰ˆ)</h1>
        <p class="text-gray-600 mb-8">é€™å€‹å·¥å…·èƒ½å¹«æ‚¨å°‡åœ–ç‰‡ã€Œæ°¸ä¹…åµŒå…¥ã€åˆ°éŠæˆ²æª”æ¡ˆä¸­ï¼Œ<br>ä¸¦ä¿®å¾©äº†ä¹‹å‰ç„¡æ³•åŸ·è¡Œçš„ç¨‹å¼ç¢¼éŒ¯èª¤ã€‚</p>

        <!-- æ­¥é©Ÿ 1 -->
        <div class="mb-8 p-6 bg-blue-50 rounded-xl border-2 border-blue-100">
            <h2 class="text-xl font-bold text-blue-800 mb-4">æ­¥é©Ÿ 1ï¼šé¸æ“‡é¦–é åœ–ç‰‡</h2>
            <input type="file" id="imageInput" accept="image/*" class="block w-full text-sm text-gray-500
              file:mr-4 file:py-2 file:px-4
              file:rounded-full file:border-0
              file:text-sm file:font-semibold
              file:bg-blue-500 file:text-white
              file:cursor-pointer hover:file:bg-blue-600
            "/>
            <p id="statusText" class="mt-3 text-sm text-gray-500">å°šæœªé¸æ“‡åœ–ç‰‡ï¼ˆè‹¥ä¸é¸æ“‡å°‡ä½¿ç”¨é è¨­æ‰‹ç¹ªåœ–ï¼‰</p>
            <img id="preview" class="mt-4 max-h-48 mx-auto rounded shadow hidden" />
        </div>

        <!-- æ­¥é©Ÿ 2 -->
        <div class="mb-6">
            <button id="downloadBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transform transition hover:scale-105 flex items-center justify-center text-xl disabled:opacity-50 disabled:cursor-not-allowed">
                <span>â¬‡ï¸ æ­¥é©Ÿ 2ï¼šä¸‹è¼‰æ‰“åŒ…å¥½çš„éŠæˆ²æª”</span>
            </button>
            <p class="mt-2 text-xs text-gray-400">ä¸‹è¼‰å¾Œçš„æª”æ¡ˆå³åŒ…å«åœ–ç‰‡ï¼Œå¯ç›´æ¥å‚³çµ¦å­¸ç”Ÿ</p>
        </div>
    </div>

    <!-- é€™è£¡æ˜¯éŠæˆ²çš„åŸå§‹ç¢¼æ¨¡æ¿ï¼Œéš±è—ä¸é¡¯ç¤ºï¼Œåƒ…ä¾›æ‰“åŒ…ä½¿ç”¨ -->
    <textarea id="gameSourceTemplate" style="display:none;">
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ‹å­¸å°å­¸å ‚ï¼šå°è¯å¤§å†’éšª</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: #FFF7ED; }
        .font-serif { font-family: "PMingLiU", "LiSong Pro", serif; }
        .writing-vertical-rl { writing-mode: vertical-rl; }
        @keyframes bounce-slow { 0%, 100% { transform: translateY(-5%); } 50% { transform: translateY(5%); } }
        .animate-bounce-slow { animation: bounce-slow 3s infinite; }
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root">
        <div style="height: 100vh; display: flex; justify-content: center; align-items: center; color: #ea580c; font-size: 1.5rem; font-weight: bold;">
            æ­£åœ¨è¼‰å…¥éŠæˆ²ä¸­...
        </div>
    </div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // åœ–ç¤ºå…ƒä»¶
        const Icon = ({ path, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );
        const BookOpen = (props) => <Icon {...props} path={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>} />;
        const Star = (props) => <Icon {...props} path={<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />} />;
        const Trophy = (props) => <Icon {...props} path={<><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></>} />;
        const ArrowRight = (props) => <Icon {...props} path={<><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></>} />;
        const CheckCircle = (props) => <Icon {...props} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />;
        const XCircle = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></>} />;
        const Award = (props) => <Icon {...props} path={<><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></>} />;
        const Home = (props) => <Icon {...props} path={<><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></>} />;
        const Upload = (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></>} />;

        // æ ¸å¿ƒè³‡æ–™
        const DEFAULT_IMAGE_SRC = "__IMAGE_PLACEHOLDER__"; // é€™æ˜¯æ›¿æ›æ¨™è¨˜

        const LESSON_DATA = [
            { id: 1, title: "èªè­˜å°è¯ä¸‰å…„å¼Ÿ", content: "å°è¯æ˜¯ä¸­åœ‹å‚³çµ±æ–‡åŒ–ï¼Œä¸»è¦åˆ†ç‚ºä¸‰ç¨®ï¼š\n\n1. **æ˜¥è¯**ï¼šéå¹´è²¼çš„ï¼Œç´…è‰²å–œæ°£ï¼Œç¥ˆæ±‚å¥½é‹ã€‚\n(é—œéµå­—ï¼šæ˜¥ã€ç¦ã€æ­²ã€å¹´)\n\n2. **è³€è¯**ï¼šæ…¶ç¥å–œäº‹ç”¨çš„ï¼Œå¦‚çµå©šã€å£½å®´ã€é–‹æ¥­ã€‚\n(é—œéµå­—ï¼šå©šã€å£½ã€æ¥­ã€å–œ)\n\n3. **å»Ÿç¥ è¯**ï¼šè²¼åœ¨å»Ÿå®‡ï¼Œæ­Œé Œç¥æ˜æˆ–ç¥ˆæ±‚åœ‹æ³°æ°‘å®‰ã€‚\n(é—œéµå­—ï¼šç¥ã€æ©ã€é¢¨èª¿é›¨é †)", imageType: "types" },
            { id: 2, title: "å¹³ä»„è¦å‰‡å¤§è§£å¯†", content: "å°è¯æœ€é‡è¦–ã€Œå¹³ä»„ã€ï¼Œé€™æ±ºå®šäº†å“ªå¼µè²¼å³é‚Š(ä¸Šè¯)ï¼Œå“ªå¼µè²¼å·¦é‚Š(ä¸‹è¯)ã€‚\n\nå£è¨£ï¼š**ã€Œä»„èµ·å¹³æ”¶ã€**\n\n* **ä¸Šè¯ (å³é‚Š)**ï¼šæœ€å¾Œä¸€å€‹å­—æ˜¯ **ä»„è²** (æ³¨éŸ³ä¸‰ã€å››è²)ã€‚\n* **ä¸‹è¯ (å·¦é‚Š)**ï¼šæœ€å¾Œä¸€å€‹å­—æ˜¯ **å¹³è²** (æ³¨éŸ³ä¸€ã€äºŒè²)ã€‚\n\nä¾‹å¦‚ï¼šã€Œå¤©å¢æ­²æœˆäººå¢**å£½**(å››è²/ä»„)ã€ï¼Œæ˜¯ä¸Šè¯ï¼", imageType: "rules" },
            { id: 3, title: "è²¼å°è¯çš„æ™‚æ©Ÿ", content: "è²¼éŒ¯å¯æ˜¯æœƒé¬§ç¬‘è©±çš„å–”ï¼\n\n* **æ˜¥è¯**ï¼šé™¤å¤•ç•¶å¤©æ—©ä¸Š6é»åˆ°ä¸­åˆ12é»è²¼æœ€å¥½ã€‚\n* **è³€è¯**ï¼šå–œäº‹ç™¼ç”Ÿå‰æˆ–ç•¶å¤©è²¼ã€‚\n* **é¢å°å¤§é–€**ï¼šå³é‚Šè²¼ä¸Šè¯ï¼Œå·¦é‚Šè²¼ä¸‹è¯ï¼Œä¸Šé¢è²¼æ©«æ‰¹ã€‚", imageType: "timing" }
        ];

        const QUIZ_POOL = [
            { q: "å°è¯çš„ä¸Šè¯ï¼Œæœ€å¾Œä¸€å€‹å­—é€šå¸¸æ˜¯ä»€éº¼è²èª¿ï¼Ÿ", options: ["å¹³è² (ä¸€ã€äºŒè²)", "ä»„è² (ä¸‰ã€å››è²)", "è¼•è²"], ans: 1 },
            { q: "ã€Œçˆ†ç«¹ä¸€è²é™¤èˆŠæ­²ã€é€™å¥è©©æœ€å¾Œä¸€å€‹å­—ã€Œæ­²ã€æ˜¯å››è²ï¼Œæ‰€ä»¥å®ƒæ˜¯ï¼Ÿ", options: ["ä¸Šè¯", "ä¸‹è¯", "æ©«æ‰¹"], ans: 0 },
            { q: "çœ‹åˆ°ã€Œæ–°å©šå¤§å–œã€å››å€‹å­—ï¼Œé€™å±¬æ–¼å“ªç¨®å°è¯ï¼Ÿ", options: ["æ˜¥è¯", "è³€è¯", "å»Ÿç¥ è¯"], ans: 1 },
            { q: "è²¼å°è¯æ™‚ï¼Œç•¶ä½ é¢å°å¤§é–€ï¼Œä¸Šè¯æ‡‰è©²è²¼åœ¨å“ªä¸€é‚Šï¼Ÿ", options: ["å·¦é‚Š", "å³é‚Š", "ä¸­é–“"], ans: 1 },
            { q: "ã€Œåœ‹æ³°æ°‘å®‰ã€é€™é¡ç¥ˆæ±‚åœ‹å®¶å®‰å®šçš„è©èªï¼Œæœ€å¸¸å‡ºç¾åœ¨å“ªè£¡ï¼Ÿ", options: ["å©šç¦®", "å»Ÿå®‡", "å•†åº—"], ans: 1 },
            { q: "ä¸‹åˆ—å“ªä¸€å€‹é—œéµå­—æœ€å¸¸å‡ºç¾åœ¨ã€Œæ˜¥è¯ã€ä¸­ï¼Ÿ", options: ["å£½", "æ˜¥", "é†«"], ans: 1 },
            { q: "ã€Œä»„èµ·å¹³æ”¶ã€ä¸­çš„ã€Œå¹³æ”¶ã€æŒ‡çš„æ˜¯ä»€éº¼ï¼Ÿ", options: ["ä¸Šè¯æœ€å¾Œä¸€å­—å¹³è²", "ä¸‹è¯æœ€å¾Œä¸€å­—å¹³è²", "æ©«æ‰¹æœ€å¾Œä¸€å­—å¹³è²"], ans: 1 },
            { q: "é™¤å¤•ç•¶å¤©è²¼æ˜¥è¯çš„æœ€ä½³æ™‚æ®µæ˜¯ï¼Ÿ", options: ["åŠå¤œ12é»", "æ—©ä¸Š6é»åˆ°ä¸­åˆ12é»", "ä¸‹åˆ4é»å¾Œ"], ans: 1 }
        ];

        const LEVEL_1_POOL = [
            { text: "ä¸€å…ƒå¾©å§‹", type: "ä¸Šè¯", tone: "ä»„ (ä¸‰è²)" }, { text: "è¬è±¡æ›´æ–°", type: "ä¸‹è¯", tone: "å¹³ (ä¸€è²)" },
            { text: "ä¸‰é™½é–‹æ³°", type: "ä¸Šè¯", tone: "ä»„ (å››è²)" }, { text: "äº”ç¦è‡¨é–€", type: "ä¸‹è¯", tone: "å¹³ (äºŒè²)" },
            { text: "æ˜¥è‡¨å¤§åœ°", type: "ä¸Šè¯", tone: "ä»„ (å››è²)" }, { text: "ç¦æ»¿äººé–“", type: "ä¸‹è¯", tone: "å¹³ (ä¸€è²)" },
            { text: "æºé æµé•·", type: "ä¸‹è¯", tone: "å¹³ (äºŒè²)" }, { text: "æ ¹æ·±è‘‰èŒ‚", type: "ä¸Šè¯", tone: "ä»„ (å››è²)" },
            { text: "æµ·é—Šé­šèº", type: "ä¸Šè¯", tone: "ä»„ (å››è²)" }, { text: "å¤©é«˜é³¥é£›", type: "ä¸‹è¯", tone: "å¹³ (ä¸€è²)" },
            { text: "é¢¨èª¿é›¨é †", type: "ä¸Šè¯", tone: "ä»„ (å››è²)" }, { text: "åœ‹æ³°æ°‘å®‰", type: "ä¸‹è¯", tone: "å¹³ (ä¸€è²)" }
        ];

        const LEVEL_2_POOL = [
            { top: "å¤©å¢æ­²æœˆäººå¢å£½", bottom: "æ˜¥æ»¿ä¹¾å¤ç¦æ»¿é–€", hint: "æ˜¥è¯" },
            { top: "çˆ†ç«¹ä¸€è²é™¤èˆŠæ­²", bottom: "æ¡ƒç¬¦è¬æˆ¶æ›´æ–°æ˜¥", hint: "æ˜¥è¯" },
            { top: "ç”Ÿæ„èˆˆéš†é€šå››æµ·", bottom: "è²¡æºå»£é€²é”ä¸‰æ±Ÿ", hint: "è³€è¯(é–‹æ¥­)" },
            { top: "ç¦å¦‚æ±æµ·é•·æµæ°´", bottom: "å£½æ¯”å—å±±ä¸è€æ¾", hint: "è³€è¯(ç¥å£½)" },
            { top: "è¬é‡Œå’Œé¢¨ç”ŸæŸ³è‘‰", bottom: "äº”é™µæ˜¥è‰²æ³›æ¡ƒèŠ±", hint: "æ˜¥è¯" },
            { top: "æ˜¥é¢¨æ˜¥é›¨æ˜¥å¸¸åœ¨", bottom: "å–œæ—¥å–œäººå–œäº‹å¤š", hint: "æ˜¥è¯" },
            { top: "æœ‰æ±‚å¿…æ‡‰å¨éˆé¡¯", bottom: "ç„¡æ„Ÿä¸é€šæƒ æ¾¤é•·", hint: "å»Ÿç¥ è¯" },
            { top: "æ›¸å±±æœ‰è·¯å‹¤ç‚ºå¾‘", bottom: "å­¸æµ·ç„¡æ¶¯è‹¦ä½œèˆŸ", hint: "å‹µå¿—(æ›¸æˆ¿)" },
            { top: "é–€è¿æ˜¥å¤ç§‹å†¬ç¦", bottom: "æˆ¶ç´æ±è¥¿å—åŒ—è²¡", hint: "æ˜¥è¯(æ‹›è²¡)" }
        ];

        const LEVEL_3_POOL = [
            { q: "ã€Œç™½é¦–é½Šçœ‰é´›é´¦æ¯”ç¿¼ï¼Œé’é™½å•Ÿç‘æ¡ƒæåŒå¿ƒã€é©ç”¨æ–¼ï¼Ÿ", options: ["è³€æ–°å©š", "è³€é–‹æ¥­", "è³€å£½", "è¼“è¯"], ans: 0 },
            { q: "ã€Œæ…ˆç«¹é¢¨å’Œï¼Œä¸€å ‚æ˜¥æ»¿ã€é©ç”¨æ–¼ï¼Ÿ", options: ["ç”·å£½", "å¥³å£½", "é›™å£½", "ç”Ÿå­"], ans: 1 }, 
            { q: "ã€Œè£•åœ‹è¶³æ°‘ï¼Œäººå£½å¹´è±ã€æœ€é©åˆè²¼åœ¨å“ªè£¡ï¼Ÿ", options: ["é†«é™¢", "ç±³åº—/ç³§è¡Œ", "æ›¸å±€", "è­¦å¯Ÿå±€"], ans: 1 },
            { q: "ã€Œå¦™æ‰‹å›æ˜¥ï¼Œææ—æ˜¥æš–ã€é©ç”¨æ–¼ï¼Ÿ", options: ["èŠ±åº—", "é†«é™¢/è¨ºæ‰€", "å­¸æ ¡", "é¤å»³"], ans: 1 },
            { q: "ä¸‹åˆ—å“ªä¸€å‰¯å°è¯é©åˆè²¼åœ¨æ›¸æˆ¿ï¼Ÿ", options: ["ç”Ÿæ„èˆˆéš†é€šå››æµ·", "é¢¨èª¿é›¨é †å…†è±å¹´", "å®¤é›…ä½•é ˆå¤§ï¼ŒèŠ±é¦™ä¸åœ¨å¤š", "å®¢è‡³å¦‚æ­¸"], ans: 2 },
            { q: "ã€Œé›–æ˜¯æ¯«æœ«æŠ€è—ï¼Œå»æ˜¯é ‚ä¸ŠåŠŸå¤«ã€é€™å‰¯å°è¯æ˜¯æŒ‡å“ªå€‹è¡Œæ¥­ï¼Ÿ", options: ["å¸½å­åº—", "ç†é«®å»³", "ç¾å®¹é™¢", "çœ¼é¡è¡Œ"], ans: 1 },
            { q: "ã€Œè—å¤ä»Šå­¸è¡“ï¼Œèšå¤©åœ°ç²¾è¯ã€æœ€é©åˆè²¼åœ¨å“ªè£¡ï¼Ÿ", options: ["éŠ€è¡Œ", "èŒ¶é¤¨", "åœ–æ›¸é¤¨/æ›¸åº—", "å¤è‘£åº—"], ans: 2 },
            { q: "ã€Œä½†é¡˜ä¸–é–“äººç„¡ç—…ï¼Œä½•å¦¨æ¶ä¸Šè—¥ç”Ÿå¡µã€æ˜¯å“ªå€‹è¡Œæ¥­çš„ä»å¿ƒï¼Ÿ", options: ["æ°´æœè¡Œ", "å¥èº«æˆ¿", "è—¥å±€", "ç¦®å„€å…¬å¸"], ans: 2 },
            { q: "ã€Œå››é¢è·èŠ±ä¸‰é¢æŸ³ï¼Œä¸€åŸå±±è‰²åŠåŸæ¹–ã€æå¯«çš„æ˜¯å“ªå€‹å­£ç¯€ï¼Ÿ", options: ["æ˜¥å­£", "å¤å­£", "ç§‹å­£", "å†¬å­£"], ans: 1 },
            { q: "ã€Œè¿‘æ°´æ¨“å°å…ˆå¾—æœˆï¼Œå‘é™½èŠ±æœ¨æ—©é€¢æ˜¥ã€ä¸­ï¼Œã€Œå‘é™½èŠ±æœ¨ã€å¸¸æ¯”å–»ï¼Ÿ", options: ["å¾—åˆ°ç‰¹åˆ¥çš„æ©æƒ æˆ–æ©Ÿé‡", "å‹¤å‹çš„äºº", "ç¾éº—çš„é¢¨æ™¯", "æ™‚é–“çš„æµé€"], ans: 0 }
        ];

        const shuffleArray = (array) => {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        };

        function CoupletGameApp() {
            const [screen, setScreen] = useState('home'); 
            const [unlockedLevels, setUnlockedLevels] = useState([false, false, false]); 
            const [quizPassed, setQuizPassed] = useState(false);
            const [currentLevel, setCurrentLevel] = useState(1);
            const [score, setScore] = useState(0);
            const [playerName, setPlayerName] = useState("");
            const [homeImage, setHomeImage] = useState(DEFAULT_IMAGE_SRC);
            
            const [gameQuestions, setGameQuestions] = useState([]);
            const [currentQIndex, setCurrentQIndex] = useState(0);
            const [feedback, setFeedback] = useState(null); 
            const [showExplanation, setShowExplanation] = useState(false);

            const startTeaching = () => setScreen('teach');
            
            const startQuiz = () => {
                const questions = shuffleArray(QUIZ_POOL).slice(0, 3);
                setGameQuestions(questions);
                setCurrentQIndex(0);
                setScore(0);
                setScreen('quiz');
            };

            const startGame = (level) => {
                setCurrentLevel(level);
                setScore(0);
                setCurrentQIndex(0);
                setFeedback(null);
                setShowExplanation(false);
                let questions = [];
                if (level === 1) {
                    const raw = shuffleArray(LEVEL_1_POOL).slice(0, 5);
                    questions = raw.map(item => ({...item, qType: 'identity'}));
                } else if (level === 2) {
                    const raw = shuffleArray(LEVEL_2_POOL).slice(0, 5);
                    questions = raw.map(item => {
                        const wrongOptions = shuffleArray(LEVEL_2_POOL.filter(x => x.top !== item.top)).slice(0, 3).map(x => x.bottom);
                        const options = shuffleArray([item.bottom, ...wrongOptions]);
                        return { ...item, options, qType: 'match' };
                    });
                } else if (level === 3) {
                    questions = shuffleArray(LEVEL_3_POOL).slice(0, 5);
                }
                setGameQuestions(questions);
                setScreen('game');
            };

            // --- å­ç•«é¢ Render Function ---
            const RenderHome = () => (
                <div className="flex flex-col items-center justify-center min-h-screen bg-orange-50 p-4">
                    <div className="bg-white p-8 rounded-3xl shadow-xl border-4 border-red-500 max-w-lg w-full text-center relative overflow-hidden">
                        <div className="absolute top-0 left-4 w-12 h-24 bg-red-600 rounded-b-lg flex flex-col items-center justify-center text-yellow-100 font-serif font-bold shadow-md z-10"><div>å°</div><div>è¯</div></div>
                        <div className="absolute top-0 right-4 w-12 h-24 bg-red-600 rounded-b-lg flex flex-col items-center justify-center text-yellow-100 font-serif font-bold shadow-md z-10"><div>å¤§</div><div>å¸«</div></div>
                        <h1 className="text-4xl font-extrabold text-red-600 mt-16 mb-4 tracking-wider">åœ‹å­¸å°å­¸å ‚</h1>
                        <div className="w-full rounded-xl mb-6 overflow-hidden border-2 border-red-200 relative bg-gray-100 group shadow-md">
                            {homeImage && homeImage !== "__IMAGE_PLACEHOLDER__" ? (
                                <img src={homeImage} alt="é¦–é åœ–" className="w-full h-auto object-contain" />
                            ) : (
                                <div className="w-full h-56 bg-blue-100 flex items-center justify-center text-gray-500">é è¨­åœ–ç‰‡</div>
                            )}
                        </div>
                        <div className="space-y-4">
                            <button onClick={startTeaching} className="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-6 rounded-2xl shadow-lg flex items-center justify-center text-xl"><BookOpen className="mr-2" /> é–‹å§‹ä¸Šèª²</button>
                            <button onClick={() => setScreen('gameSelect')} disabled={!quizPassed} className={`w-full font-bold py-4 px-6 rounded-2xl shadow-lg flex items-center justify-center text-xl ${quizPassed ? 'bg-red-500 hover:bg-red-600 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}><Trophy className="mr-2" /> æŒ‘æˆ°é—œå¡ {quizPassed ? '' : '(éœ€å…ˆé€šéæ¸¬é©—)'}</button>
                            {quizPassed && <button onClick={() => setScreen('certificate')} className="w-full bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-3 px-6 rounded-2xl shadow-md flex items-center justify-center"><Award className="mr-2" /> é ˜å–çç‹€</button>}
                        </div>
                    </div>
                </div>
            );

            const RenderTeach = () => {
                const [step, setStep] = useState(0);
                return (
                    <div className="min-h-screen bg-orange-50 flex flex-col items-center p-4">
                        <div className="w-full max-w-2xl bg-white rounded-3xl shadow-xl overflow-hidden border-2 border-orange-200 mt-4">
                            <div className="bg-blue-500 p-4 text-white text-center text-xl font-bold flex justify-between items-center"><span>ç¬¬ {step + 1} èª²ï¼š{LESSON_DATA[step].title}</span><button onClick={() => setScreen('home')} className="text-sm bg-blue-700 px-3 py-1 rounded-full">å›é¦–é </button></div>
                            <div className="p-8 min-h-[400px] flex flex-col items-center justify-center">
                                <div className="mb-8 text-9xl animate-bounce-slow">{LESSON_DATA[step].imageType === 'types' ? 'ğŸ®' : LESSON_DATA[step].imageType === 'rules' ? 'ğŸ“' : 'ğŸšª'}</div>
                                <div className="text-lg text-gray-700 leading-loose whitespace-pre-line text-left w-full bg-yellow-50 p-6 rounded-xl border border-yellow-200">{LESSON_DATA[step].content}</div>
                            </div>
                            <div className="p-4 bg-gray-50 flex justify-between items-center">
                                <button disabled={step === 0} onClick={() => setStep(s => s - 1)} className={`px-6 py-2 rounded-xl font-bold ${step===0 ? 'bg-gray-200 text-gray-400' : 'bg-blue-100 text-blue-600'}`}>ä¸Šä¸€é </button>
                                {step < LESSON_DATA.length - 1 ? <button onClick={() => setStep(s => s + 1)} className="px-6 py-2 rounded-xl font-bold bg-blue-500 text-white flex items-center">ä¸‹ä¸€é  <ArrowRight className="ml-1" /></button> : <button onClick={startQuiz} className="px-6 py-2 rounded-xl font-bold bg-red-500 text-white flex items-center animate-pulse">åƒåŠ éš¨å ‚è€ƒ <Star className="ml-1" /></button>}
                            </div>
                        </div>
                    </div>
                );
            };

            const RenderQuiz = () => {
                const question = gameQuestions[currentQIndex];
                const handleAnswer = (idx) => {
                    if (feedback) return;
                    const isCorrect = idx === question.ans;
                    setFeedback(isCorrect ? 'correct' : 'wrong');
                    if (isCorrect) setScore(s => s + 1);
                    setTimeout(() => {
                        setFeedback(null);
                        if (currentQIndex < gameQuestions.length - 1) setCurrentQIndex(c => c + 1);
                        else {
                            const finalScore = score + (isCorrect ? 1 : 0);
                            if (finalScore === gameQuestions.length) { setQuizPassed(true); setUnlockedLevels([true, false, false]); setScreen('quizSuccess'); }
                            else setScreen('quizFail');
                        }
                    }, 1000);
                };
                if (!question) return <div>Loading...</div>;
                return (
                    <div className="min-h-screen bg-green-50 flex items-center justify-center p-4"><div className="bg-white p-8 rounded-3xl shadow-xl border-4 border-green-400 max-w-lg w-full">
                        <div className="flex justify-between items-center mb-4"><h2 className="text-2xl font-bold text-green-700">éš¨å ‚å°æ¸¬é©—</h2><span className="text-sm font-bold bg-green-100 text-green-800 px-3 py-1 rounded-full">{currentQIndex + 1} / {gameQuestions.length}</span></div>
                        <p className="text-center text-gray-500 mb-6">ç­”å°æ‰€æœ‰é¡Œç›®æ‰èƒ½è§£é–éŠæˆ²å–”ï¼</p>
                        <div className="bg-green-50 p-6 rounded-xl mb-6 text-lg font-medium text-gray-800 border border-green-100 min-h-[100px] flex items-center justify-center">{question.q}</div>
                        <div className="space-y-3">{question.options.map((opt, idx) => (<button key={idx} onClick={() => handleAnswer(idx)} className={`w-full p-4 rounded-xl text-left text-lg font-bold border-2 ${feedback === null ? 'bg-white border-gray-200 hover:border-green-400' : ''} ${feedback === 'correct' && idx === question.ans ? 'bg-green-500 text-white' : ''} ${feedback === 'wrong' && idx !== question.ans ? 'opacity-40' : ''} ${feedback === 'wrong' && idx === question.ans ? 'bg-green-500 text-white' : ''} ${feedback === 'wrong' && idx !== question.ans && feedback ? 'bg-red-100' : ''}`}>{opt}</button>))}</div>
                    </div></div>
                );
            };

            const RenderQuizResult = ({ success }) => (
                <div className="min-h-screen bg-orange-50 flex items-center justify-center p-4"><div className="bg-white p-8 rounded-3xl shadow-xl text-center max-w-md w-full border-2 border-orange-100">
                    <div className="text-7xl mb-4 animate-bounce">{success ? 'ğŸ‰' : 'ğŸ˜…'}</div>
                    <h2 className="text-3xl font-bold mb-4 text-gray-800">{success ? 'æ­å–œé€šéï¼' : 'å†æ¥å†å²ï¼'}</h2>
                    <div className="flex gap-4 justify-center"><button onClick={() => setScreen('home')} className="bg-gray-200 text-gray-700 px-6 py-3 rounded-xl font-bold">å›é¦–é </button>{success ? <button onClick={() => setScreen('gameSelect')} className="bg-red-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg animate-pulse">å»é—–é—œ</button> : <button onClick={startTeaching} className="bg-blue-500 text-white px-6 py-3 rounded-xl font-bold">è¤‡ç¿’èª²ç¨‹</button>}</div>
                </div></div>
            );

            const RenderGameSelect = () => (
                <div className="min-h-screen bg-blue-50 flex flex-col items-center p-4"><h2 className="text-3xl font-extrabold text-blue-800 mt-8 mb-6">é¸æ“‡æŒ‘æˆ°é›£åº¦</h2><div className="grid gap-6 w-full max-w-md">
                    <div onClick={() => startGame(1)} className="bg-white p-6 rounded-2xl shadow-lg border-b-4 border-green-500 cursor-pointer hover:-translate-y-1"><h3 className="text-xl font-bold">åˆç´šå­¸å¾’ (äº”è¨€)</h3><p className="text-sm text-gray-500">åˆ†è¾¨ä¸Šè¯èˆ‡ä¸‹è¯</p></div>
                    <div onClick={() => unlockedLevels[0] ? startGame(2) : null} className={`bg-white p-6 rounded-2xl shadow-lg border-b-4 border-yellow-500 ${unlockedLevels[0]?'cursor-pointer hover:-translate-y-1':'opacity-50 grayscale'}`}><h3 className="text-xl font-bold">ä¸­ç´šå¯«æ‰‹ (ä¸ƒè¨€)</h3><p className="text-sm text-gray-500">ä¸Šä¸‹è¯é…å°</p></div>
                    <div onClick={() => unlockedLevels[1] ? startGame(3) : null} className={`bg-white p-6 rounded-2xl shadow-lg border-b-4 border-red-500 ${unlockedLevels[1]?'cursor-pointer hover:-translate-y-1':'opacity-50 grayscale'}`}><h3 className="text-xl font-bold">åœ‹å­¸å¤§å¸« (é­”ç‹)</h3><p className="text-sm text-gray-500">å ´åˆèˆ‡å­£ç¯€</p></div>
                    <button onClick={() => setScreen('home')} className="mt-4 text-gray-500 font-bold hover:text-gray-700"><Home className="inline mr-2"/> è¿”å›é¦–é </button>
                </div></div>
            );

            const RenderGamePlay = () => {
                const question = gameQuestions[currentQIndex];
                if (!question) return <div>Loading...</div>;
                const nextQuestion = () => {
                    setFeedback(null); setShowExplanation(false);
                    if (currentQIndex < gameQuestions.length - 1) setCurrentQIndex(c => c + 1);
                    else {
                        if (currentLevel === 1) setUnlockedLevels(p => [p[0], true, p[2]]);
                        else if (currentLevel === 2) setUnlockedLevels(p => [p[0], p[1], true]);
                        setScreen('levelComplete');
                    }
                };
                const handleAns = (val, isIdx = false) => {
                    if (feedback) return;
                    let isCorrect = false;
                    if (currentLevel === 1) isCorrect = val === question.type;
                    else if (currentLevel === 2) isCorrect = val === question.bottom;
                    else isCorrect = val === question.ans;
                    
                    setFeedback(isCorrect ? 'correct' : 'wrong');
                    if (isCorrect) setScore(s => s + 1);
                    setShowExplanation(true);
                };

                return (
                    <div className="min-h-screen bg-red-50 flex flex-col items-center p-4"><div className="w-full max-w-lg">
                        <div className="flex justify-between mb-6"><span className="bg-white px-4 py-2 rounded-full shadow font-bold">é—œå¡ {currentLevel}</span><span className="bg-white px-4 py-2 rounded-full shadow font-bold text-orange-600">åˆ†æ•¸: {score}</span></div>
                        <div className="bg-white p-6 rounded-3xl shadow-xl border-2 border-red-100 min-h-[450px] flex flex-col justify-between">
                            <div className="flex-1 flex flex-col items-center justify-center mb-6">
                                {currentLevel === 1 && <><h3 className="text-gray-500 mb-4">é€™å¥æ˜¯ä¸Šè¯é‚„æ˜¯ä¸‹è¯ï¼Ÿ</h3><div className="bg-red-600 text-yellow-100 text-4xl font-serif font-bold py-8 px-6 writing-vertical-rl rounded shadow-inner">{question.text}</div></>}
                                {currentLevel === 2 && <><h3 className="text-gray-500 mb-4">è«‹å¹«ä¸Šè¯æ‰¾ä¸‹è¯</h3><div className="flex gap-4"><div className="bg-red-600 text-yellow-100 text-2xl font-serif font-bold py-6 px-4 writing-vertical-rl rounded shadow">{question.top}</div><div className="bg-gray-100 text-gray-400 text-2xl font-serif font-bold py-6 px-4 writing-vertical-rl rounded border-2 border-dashed">?</div></div></>}
                                {currentLevel === 3 && <div className="text-xl font-bold text-center bg-red-50 p-6 rounded w-full">{question.q}</div>}
                            </div>
                            <div className="space-y-3">
                                {currentLevel === 1 && !feedback && <div className="grid grid-cols-2 gap-4"><button onClick={()=>handleAns('ä¸Šè¯')} className="bg-blue-100 text-blue-800 font-bold py-4 rounded-xl">ä¸Šè¯ (å³)</button><button onClick={()=>handleAns('ä¸‹è¯')} className="bg-green-100 text-green-800 font-bold py-4 rounded-xl">ä¸‹è¯ (å·¦)</button></div>}
                                {currentLevel === 2 && !feedback && question.options.map((opt, i) => <button key={i} onClick={()=>handleAns(opt)} className="w-full bg-gray-50 border p-3 rounded text-left font-serif font-bold hover:bg-red-50">{opt}</button>)}
                                {currentLevel === 3 && !feedback && question.options.map((opt, i) => <button key={i} onClick={()=>handleAns(i, true)} className="w-full bg-gray-50 border p-3 rounded text-left hover:bg-blue-50">{opt}</button>)}
                                {feedback && <div className="animate-fade-in-up"><div className={`p-4 rounded-xl mb-4 flex items-center ${feedback==='correct'?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}`}>{feedback==='correct'?'ç­”å°äº†ï¼':'ç­”éŒ¯å›‰ï¼'}</div><button onClick={nextQuestion} className="w-full bg-gray-800 text-white font-bold py-4 rounded-xl">ä¸‹ä¸€é¡Œ <ArrowRight className="inline ml-2"/></button></div>}
                            </div>
                        </div>
                    </div></div>
                );
            };

            const RenderLevelComplete = () => {
                const isPass = (score / gameQuestions.length) >= 0.6;
                return (
                    <div className="min-h-screen bg-yellow-50 flex items-center justify-center p-4"><div className="bg-white p-8 rounded-3xl shadow-xl text-center max-w-md w-full border-4 border-yellow-400">
                        <div className="text-8xl mb-6">{isPass ? 'ğŸ†' : 'ğŸ’ª'}</div>
                        <h2 className="text-3xl font-bold mb-2">{isPass ? 'æŒ‘æˆ°æˆåŠŸï¼' : 'æŒ‘æˆ°å¤±æ•—'}</h2>
                        <p className="text-5xl font-black text-blue-600 my-6">{score} <span className="text-2xl text-gray-400 font-normal">/ {gameQuestions.length}</span></p>
                        <div className="space-y-3">
                            <button onClick={() => setScreen('gameSelect')} className="w-full bg-blue-500 text-white py-3 rounded-xl font-bold">å›åˆ°é—œå¡åˆ—è¡¨</button>
                            {!isPass && <button onClick={() => startGame(currentLevel)} className="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold">å†è©¦ä¸€æ¬¡</button>}
                            {isPass && currentLevel === 3 && <button onClick={() => setScreen('certificate')} className="w-full bg-yellow-400 text-yellow-900 py-3 rounded-xl font-bold shadow-lg animate-pulse">é ˜å–æ¦®è­½çç‹€</button>}
                        </div>
                    </div></div>
                );
            };

            const RenderCertificate = () => {
                return (
                    <div className="min-h-screen bg-gray-100 flex flex-col items-center p-4">
                        <div className="bg-white p-4 rounded shadow mb-6 w-full max-w-md print:hidden"><label className="font-bold">è¼¸å…¥åå­—ï¼š</label><input type="text" value={playerName} onChange={(e)=>setPlayerName(e.target.value)} placeholder="ç‹å°æ˜" className="w-full p-2 border rounded mt-1"/></div>
                        <div className="bg-[#FFFBF0] border-[16px] border-double border-[#8B4513] p-8 max-w-2xl w-full text-center shadow-2xl">
                            <div className="py-8 border-4 border-[#DAA520]">
                                <h1 className="text-5xl font-serif font-bold text-red-700 mb-8">æ¦®è­½çç‹€</h1>
                                <p className="text-xl mb-4 font-serif">èŒ²è­‰æ˜</p>
                                <p className="text-4xl font-bold mb-6 font-serif border-b-2 border-gray-300 inline-block min-w-[200px]">{playerName || "____________"}</p>
                                <p className="text-xl mb-8 font-serif">æ–¼ã€Œå°è¯å¤§å†’éšªã€éŠæˆ²ä¸­ï¼Œ<br/>å±•ç¾å“è¶Šåœ‹å­¸é€ è©£ï¼Œç‰¹é ’æ­¤ç‹€ã€‚</p>
                                <div className="text-right"><p className="text-lg font-serif">æ—¥æœŸï¼š{new Date().toLocaleDateString()}</p></div>
                            </div>
                        </div>
                        <div className="mt-8 flex gap-4 print:hidden"><button onClick={()=>setScreen('home')} className="bg-gray-500 text-white px-6 py-3 rounded font-bold">å›é¦–é </button><button onClick={()=>window.print()} className="bg-blue-600 text-white px-6 py-3 rounded font-bold shadow">åˆ—å°çç‹€</button></div>
                    </div>
                );
            };

            return (
                <div className="font-sans text-gray-800">
                   {screen === 'home' && <RenderHome />}
                   {screen === 'teach' && <RenderTeach />}
                   {screen === 'quiz' && <RenderQuiz />}
                   {screen === 'quizFail' && <RenderQuizResult success={false} />}
                   {screen === 'quizSuccess' && <RenderQuizResult success={true} />}
                   {screen === 'gameSelect' && <RenderGameSelect />}
                   {screen === 'game' && <RenderGamePlay />}
                   {screen === 'levelComplete' && <RenderLevelComplete />}
                   {screen === 'certificate' && <RenderCertificate />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<CoupletGameApp />);
    </script>
</body>
</html>
    </textarea>

    <script>
        const imageInput = document.getElementById('imageInput');
        const preview = document.getElementById('preview');
        const statusText = document.getElementById('statusText');
        const downloadBtn = document.getElementById('downloadBtn');
        const gameSourceTemplate = document.getElementById('gameSourceTemplate').value;

        let base64Image = "";

        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    base64Image = event.target.result;
                    preview.src = base64Image;
                    preview.classList.remove('hidden');
                    statusText.innerText = "âœ… åœ–ç‰‡è®€å–æˆåŠŸï¼å¯ä»¥ä¸‹è¼‰éŠæˆ²äº†";
                    statusText.className = "mt-3 text-green-600 font-bold";
                    downloadBtn.disabled = false;
                };
                reader.readAsDataURL(file);
            }
        });

        downloadBtn.addEventListener('click', function() {
            // å¦‚æœæ²’æœ‰é¸åœ–ç‰‡ï¼Œä½¿ç”¨ä¸€å€‹ç©ºçš„ Base64 æˆ–æ˜¯ç‰¹å®šçš„æ¨™è¨˜
            const finalImage = base64Image || ""; 
            
            // å°‡åœ–ç‰‡æ•¸æ“šæ³¨å…¥åˆ°æ¨¡æ¿ä¸­
            // é€™è£¡ç›´æ¥å–ä»£ __IMAGE_PLACEHOLDER__ å­—ä¸²
            const finalHtml = gameSourceTemplate.replace('"__IMAGE_PLACEHOLDER__"', JSON.stringify(finalImage));

            // å»ºç«‹ä¸‹è¼‰é€£çµ
            const blob = new Blob([finalHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "åœ‹å­¸å°å­¸å ‚_å®Œæ•´ç‰ˆ.html";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>